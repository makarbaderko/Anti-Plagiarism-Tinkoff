Module(body=[Import(names=[alias(name='os')]), ImportFrom(module='probabilistic_embeddings.criterion', names=[alias(name='Criterion')], level=0), ImportFrom(module='probabilistic_embeddings', names=[alias(name='commands')], level=0), ImportFrom(module='unittest', names=[alias(name='TestCase'), alias(name='main')], level=0), Import(names=[alias(name='torch')]), Import(names=[alias(name='yaml')]), ImportFrom(module='scipy', names=[alias(name='stats')], level=0), Import(names=[alias(name='tempfile')]), Import(names=[alias(name='numpy', asname='np')]), ImportFrom(module='probabilistic_embeddings.layers', names=[alias(name='NormalDistribution')], level=0), ImportFrom(module='probabilistic_embeddings.torch', names=[alias(name='tmp_seed')], level=0), ClassDef(name='Namesp', bases=[], keywords=[], body=[Assign(targets=[Name(id='ARGSxGU', ctx=Store())], value=List(elts=[Constant(value='cmd'), Constant(value='data'), Constant(value='name'), Constant(value='logger'), Constant(value='config'), Constant(value='train_root'), Constant(value='checkpoint'), Constant(value='no_strict_init'), Constant(value='from_stage'), Constant(value='from_seed')], ctx=Load())), FunctionDef(name='__getattr__', args=arguments(posonlyargs=[], args=[arg(arg='sel'), arg(arg='key')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[If(test=Compare(left=Name(id='key', ctx=Load()), ops=[NotIn()], comparators=[Attribute(value=Name(id='sel', ctx=Load()), attr='ARGS', ctx=Load())]), body=[Raise(exc=Call(func=Name(id='AttributeError', ctx=Load()), args=[Name(id='key', ctx=Load())], keywords=[]))], orelse=[]), Return(value=Call(func=Attribute(value=Attribute(value=Name(id='sel', ctx=Load()), attr='__dict__', ctx=Load()), attr='get', ctx=Load()), args=[Name(id='key', ctx=Load()), Constant(value=None)], keywords=[]))], decorator_list=[]), FunctionDef(name='__init__', args=arguments(posonlyargs=[], args=[arg(arg='sel')], kwonlyargs=[], kw_defaults=[], kwarg=arg(arg='kwargs'), defaults=[]), body=[Expr(value=Call(func=Attribute(value=Attribute(value=Name(id='sel', ctx=Load()), attr='__dict__', ctx=Load()), attr='update', ctx=Load()), args=[Name(id='kwargs', ctx=Load())], keywords=[]))], decorator_list=[])], decorator_list=[]), Assign(targets=[Name(id='KLD_C', ctx=Store())], value=Dict(keys=[Constant(value='dataset_params'), Constant(value='model_params'), Constant(value='criterion_params'), Constant(value='trainer_params')], values=[Dict(keys=[Constant(value='name'), Constant(value='batch_size'), Constant(value='num_workers'), Constant(value='num_validation_folds')], values=[Constant(value='debug-openset'), Constant(value=4), Constant(value=0), Constant(value=2)]), Dict(keys=[Constant(value='embedder_params'), Constant(value='distribution_type'), Constant(value='distribution_params')], values=[Dict(keys=[Constant(value='pretrained'), Constant(value='model_type')], values=[Constant(value=False), Constant(value='resnet18')]), Constant(value='gmm'), Dict(keys=[Constant(value='dim')], values=[Constant(value=16)])]), Dict(keys=[Constant(value='prior_kld_weight')], values=[Constant(value=1)]), Dict(keys=[Constant(value='num_epochs')], values=[Constant(value=1)])])), Assign(targets=[Name(id='MLS_CONFIG', ctx=Store())], value=Dict(keys=[Constant(value='dataset_params'), Constant(value='model_params'), Constant(value='criterion_params'), Constant(value='trainer_params'), Constant(value='stages')], values=[Dict(keys=[Constant(value='name'), Constant(value='batch_size'), Constant(value='num_workers'), Constant(value='num_validation_folds')], values=[Constant(value='debug-openset'), Constant(value=4), Constant(value=0), Constant(value=2)]), Dict(keys=[Constant(value='embedder_params'), Constant(value='classifier_type'), Constant(value='distribution_type'), Constant(value='distribution_params')], values=[Dict(keys=[Constant(value='pretrained'), Constant(value='model_type')], values=[Constant(value=False), Constant(value='resnet18')]), Constant(value=None), Constant(value='gmm'), Dict(keys=[Constant(value='dim')], values=[Constant(value=16)])]), Dict(keys=[Constant(value='xent_weight'), Constant(value='pfe_weight')], values=[Constant(value=0), Constant(value=1)]), Dict(keys=[Constant(value='num_epochs')], values=[Constant(value=1)]), List(elts=[Dict(keys=[Constant(value='criterion_params')], values=[Dict(keys=[Constant(value='pfe_match_self')], values=[Constant(value=True)])]), Dict(keys=[Constant(value='criterion_params')], values=[Dict(keys=[Constant(value='pfe_match_self')], values=[Constant(value=False)])])], ctx=Load())])), ClassDef(name='TestCriterion', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_hinge', args=arguments(posonlyargs=[], args=[arg(arg='sel')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Expr(value=Constant(value='ˣ͏Test Hinge !ū\x89loƨΥrss.')), Assign(targets=[Name(id='logits', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[List(elts=[Constant(value=0.1), UnaryOp(op=USub(), operand=Constant(value=0.3)), Constant(value=0.2)], ctx=Load())], ctx=Load()), List(elts=[List(elts=[Constant(value=0.5), Constant(value=0.0), UnaryOp(op=USub(), operand=Constant(value=0.1))], ctx=Load())], ctx=Load()), List(elts=[List(elts=[Constant(value=0.0), Constant(value=0.0), Constant(value=0.0)], ctx=Load())], ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=1)], ctx=Load()), List(elts=[Constant(value=0)], ctx=Load()), List(elts=[Constant(value=2)], ctx=Load())], ctx=Load())], keywords=[keyword(arg='dtype', value=Attribute(value=Name(id='torch', ctx=Load()), attr='long', ctx=Load()))])), Assign(targets=[Name(id='criterionODCWR', ctx=Store())], value=Call(func=Name(id='Criterion', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='xent_weight'), Constant(value='hinge_weight'), Constant(value='hinge_margin')], values=[Constant(value=0.0), Constant(value=1.0), Constant(value=0.1)]))])), Assign(targets=[Name(id='l', ctx=Store())], value=Call(func=Attribute(value=Call(func=Name(id='criterionODCWR', ctx=Load()), args=[Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='randn', ctx=Load()), args=[Constant(value=3), Constant(value=1), Constant(value=5)], keywords=[]), Name(id='labels', ctx=Load())], keywords=[keyword(arg='logits', value=Name(id='logits', ctx=Load()))]), attr='item', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='loss_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='mean', ctx=Load()), args=[List(elts=[Constant(value=0.5), Constant(value=0.6), Constant(value=0.0), Constant(value=0.0), Constant(value=0.1), Constant(value=0.1)], ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='sel', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Name(id='l', ctx=Load()), Name(id='loss_gt', ctx=Load())], keywords=[]))], decorator_list=[]), FunctionDef(name='_norm', args=arguments(posonlyargs=[], args=[arg(arg='sel'), arg(arg='PARAMETERS')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Expr(value=Constant(value='ł Ʈ |+    n \x98  ')), Return(value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='sqrt', ctx=Load()), args=[Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='sum', ctx=Load()), args=[ListComp(elt=Call(func=Attribute(value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='p', ctx=Load()), attr='square', ctx=Load()), args=[], keywords=[]), attr='sum', ctx=Load()), args=[], keywords=[]), attr='item', ctx=Load()), args=[], keywords=[]), generators=[comprehension(target=Name(id='p', ctx=Store()), iter=Name(id='PARAMETERS', ctx=Load()), ifs=[], is_async=0)])], keywords=[])], keywords=[]))], decorator_list=[]), FunctionDef(name='_test_gradients', args=arguments(posonlyargs=[], args=[arg(arg='sel'), arg(arg='PARAMETERS'), arg(arg='loss_fn'), arg(arg='eps')], kwonlyargs=[], kw_defaults=[], defaults=[Constant(value=0.001)]), body=[Assign(targets=[Name(id='placeholders', ctx=Store())], value=ListComp(elt=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[Call(func=Attribute(value=Name(id='p', ctx=Load()), attr='numpy', ctx=Load()), args=[], keywords=[])], keywords=[keyword(arg='requires_grad', value=Constant(value=True)), keyword(arg='dtype', value=Attribute(value=Name(id='torch', ctx=Load()), attr='double', ctx=Load()))]), generators=[comprehension(target=Name(id='p', ctx=Store()), iter=Name(id='PARAMETERS', ctx=Load()), ifs=[], is_async=0)])), With(items=[withitem(context_expr=Call(func=Name(id='tmp_seed', ctx=Load()), args=[Constant(value=0)], keywords=[]))], body=[Assign(targets=[Name(id='loss_base', ctx=Store())], value=Call(func=Name(id='loss_fn', ctx=Load()), args=[Starred(value=Name(id='placeholders', ctx=Load()), ctx=Load())], keywords=[]))]), Expr(value=Call(func=Attribute(value=Name(id='loss_base', ctx=Load()), attr='backward', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='loss_base', ctx=Store())], value=Call(func=Attribute(value=Name(id='loss_base', ctx=Load()), attr='item', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='gr_ad_norm', ctx=Store())], value=Call(func=Attribute(value=Name(id='sel', ctx=Load()), attr='_norm', ctx=Load()), args=[ListComp(elt=Attribute(value=Name(id='p', ctx=Load()), attr='grad', ctx=Load()), generators=[comprehension(target=Name(id='p', ctx=Store()), iter=Name(id='placeholders', ctx=Load()), ifs=[], is_async=0)])], keywords=[])), Assign(targets=[Name(id='updated_parameters', ctx=Store())], value=ListComp(elt=BinOp(left=Name(id='p', ctx=Load()), op=Sub(), right=BinOp(left=BinOp(left=Attribute(value=Name(id='p', ctx=Load()), attr='grad', ctx=Load()), op=Mult(), right=Name(id='eps', ctx=Load())), op=Div(), right=Name(id='gr_ad_norm', ctx=Load()))), generators=[comprehension(target=Name(id='p', ctx=Store()), iter=Name(id='placeholders', ctx=Load()), ifs=[], is_async=0)])), With(items=[withitem(context_expr=Call(func=Name(id='tmp_seed', ctx=Load()), args=[Constant(value=0)], keywords=[]))], body=[Assign(targets=[Name(id='loss_updatekjjU', ctx=Store())], value=Call(func=Attribute(value=Call(func=Name(id='loss_fn', ctx=Load()), args=[Starred(value=Name(id='updated_parameters', ctx=Load()), ctx=Load())], keywords=[]), attr='item', ctx=Load()), args=[], keywords=[]))]), Expr(value=Call(func=Attribute(value=Name(id='sel', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Compare(left=Name(id='loss_updatekjjU', ctx=Load()), ops=[Lt()], comparators=[Name(id='loss_base', ctx=Load())])], keywords=[])), With(items=[withitem(context_expr=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='no_grad', ctx=Load()), args=[], keywords=[]))], body=[For(target=Tuple(elts=[Name(id='_i', ctx=Store()), Name(id='p', ctx=Store())], ctx=Store()), iter=Call(func=Name(id='enumerate', ctx=Load()), args=[Name(id='placeholders', ctx=Load())], keywords=[]), body=[Assign(targets=[Name(id='shape', ctx=Store())], value=Attribute(value=Name(id='p', ctx=Load()), attr='shape', ctx=Load())), Assign(targets=[Name(id='p_gradfE', ctx=Store())], value=Call(func=Attribute(value=Attribute(value=Name(id='p', ctx=Load()), attr='grad', ctx=Load()), attr='flatten', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='p', ctx=Store())], value=Call(func=Attribute(value=Name(id='p', ctx=Load()), attr='flatten', ctx=Load()), args=[], keywords=[])), For(target=Tuple(elts=[Name(id='J', ctx=Store()), Name(id='v', ctx=Store())], ctx=Store()), iter=Call(func=Name(id='enumerate', ctx=Load()), args=[Name(id='p', ctx=Load())], keywords=[]), body=[Assign(targets=[Name(id='delta_p', ctx=Store())], value=Call(func=Attribute(value=Name(id='p', ctx=Load()), attr='clone', ctx=Load()), args=[], keywords=[])), AugAssign(target=Subscript(value=Name(id='delta_p', ctx=Load()), slice=Name(id='J', ctx=Load()), ctx=Store()), op=Add(), value=Name(id='eps', ctx=Load())), If(test=Compare(left=Call(func=Name(id='_len', ctx=Load()), args=[Name(id='shape', ctx=Load())], keywords=[]), ops=[Gt()], comparators=[Constant(value=1)]), body=[Assign(targets=[Name(id='delta_p', ctx=Store())], value=Call(func=Attribute(value=Name(id='delta_p', ctx=Load()), attr='reshape', ctx=Load()), args=[Starred(value=Name(id='shape', ctx=Load()), ctx=Load())], keywords=[]))], orelse=[]), Assign(targets=[Name(id='delta_placeholders', ctx=Store())], value=Call(func=Name(id='list', ctx=Load()), args=[Name(id='placeholders', ctx=Load())], keywords=[])), Assign(targets=[Subscript(value=Name(id='delta_placeholders', ctx=Load()), slice=Name(id='_i', ctx=Load()), ctx=Store())], value=Name(id='delta_p', ctx=Load())), With(items=[withitem(context_expr=Call(func=Name(id='tmp_seed', ctx=Load()), args=[Constant(value=0)], keywords=[]))], body=[Assign(targets=[Name(id='l', ctx=Store())], value=Call(func=Attribute(value=Call(func=Name(id='loss_fn', ctx=Load()), args=[Starred(value=Name(id='delta_placeholders', ctx=Load()), ctx=Load())], keywords=[]), attr='item', ctx=Load()), args=[], keywords=[]))]), Assign(targets=[Name(id='grad', ctx=Store())], value=BinOp(left=BinOp(left=Name(id='l', ctx=Load()), op=Sub(), right=Name(id='loss_base', ctx=Load())), op=Div(), right=Name(id='eps', ctx=Load()))), Assign(targets=[Name(id='grad_gt', ctx=Store())], value=Call(func=Attribute(value=Subscript(value=Name(id='p_gradfE', ctx=Load()), slice=Name(id='J', ctx=Load()), ctx=Load()), attr='item', ctx=Load()), args=[], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='sel', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Name(id='grad', ctx=Load()), Name(id='grad_gt', ctx=Load())], keywords=[keyword(arg='delta', value=Constant(value=0.05))]))], orelse=[])], orelse=[])])], decorator_list=[])], decorator_list=[]), ClassDef(name='TESTCRITERIONTRAINING', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[Expr(value=Constant(value='Π ')), FunctionDef(name='test_pfe', args=arguments(posonlyargs=[], args=[arg(arg='sel')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Expr(value=Constant(value='Tˀr·aŲin w{ithȇ pair MLS loss.')), With(items=[withitem(context_expr=Call(func=Attribute(value=Name(id='tempfile', ctx=Load()), attr='TemporaryDirectory', ctx=Load()), args=[], keywords=[]), optional_vars=Name(id='root', ctx=Store()))], body=[Assign(targets=[Name(id='config_p', ctx=Store())], value=Call(func=Attribute(value=Attribute(value=Name(id='os', ctx=Load()), attr='path', ctx=Load()), attr='join', ctx=Load()), args=[Name(id='root', ctx=Load()), Constant(value='config.yaml')], keywords=[])), With(items=[withitem(context_expr=Call(func=Name(id='open', ctx=Load()), args=[Name(id='config_p', ctx=Load()), Constant(value='w')], keywords=[]), optional_vars=Name(id='fp', ctx=Store()))], body=[Expr(value=Call(func=Attribute(value=Name(id='yaml', ctx=Load()), attr='safe_dump', ctx=Load()), args=[Name(id='MLS_CONFIG', ctx=Load()), Name(id='fp', ctx=Load())], keywords=[]))]), Assign(targets=[Name(id='_args', ctx=Store())], value=Call(func=Name(id='Namesp', ctx=Load()), args=[], keywords=[keyword(arg='cmd', value=Constant(value='train')), keyword(arg='data', value=Name(id='root', ctx=Load())), keyword(arg='config', value=Name(id='config_p', ctx=Load())), keyword(arg='logger', value=Constant(value='tensorboard')), keyword(arg='train_root', value=Name(id='root', ctx=Load()))])), Expr(value=Call(func=Attribute(value=Name(id='commands', ctx=Load()), attr='train', ctx=Load()), args=[Name(id='_args', ctx=Load())], keywords=[]))])], decorator_list=[]), FunctionDef(name='test_prior_kld', args=arguments(posonlyargs=[], args=[arg(arg='sel')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[With(items=[withitem(context_expr=Call(func=Attribute(value=Name(id='tempfile', ctx=Load()), attr='TemporaryDirectory', ctx=Load()), args=[], keywords=[]), optional_vars=Name(id='root', ctx=Store()))], body=[Assign(targets=[Name(id='config_p', ctx=Store())], value=Call(func=Attribute(value=Attribute(value=Name(id='os', ctx=Load()), attr='path', ctx=Load()), attr='join', ctx=Load()), args=[Name(id='root', ctx=Load()), Constant(value='config.yaml')], keywords=[])), With(items=[withitem(context_expr=Call(func=Name(id='open', ctx=Load()), args=[Name(id='config_p', ctx=Load()), Constant(value='w')], keywords=[]), optional_vars=Name(id='fp', ctx=Store()))], body=[Expr(value=Call(func=Attribute(value=Name(id='yaml', ctx=Load()), attr='safe_dump', ctx=Load()), args=[Name(id='KLD_C', ctx=Load()), Name(id='fp', ctx=Load())], keywords=[]))]), Assign(targets=[Name(id='_args', ctx=Store())], value=Call(func=Name(id='Namesp', ctx=Load()), args=[], keywords=[keyword(arg='cmd', value=Constant(value='train')), keyword(arg='data', value=Name(id='root', ctx=Load())), keyword(arg='config', value=Name(id='config_p', ctx=Load())), keyword(arg='logger', value=Constant(value='tensorboard')), keyword(arg='train_root', value=Name(id='root', ctx=Load()))])), Expr(value=Call(func=Attribute(value=Name(id='commands', ctx=Load()), attr='train', ctx=Load()), args=[Name(id='_args', ctx=Load())], keywords=[]))])], decorator_list=[])], decorator_list=[]), If(test=Compare(left=Name(id='__name__', ctx=Load()), ops=[Eq()], comparators=[Constant(value='__main__')]), body=[Expr(value=Call(func=Name(id='main', ctx=Load()), args=[], keywords=[]))], orelse=[])], type_ignores=[])