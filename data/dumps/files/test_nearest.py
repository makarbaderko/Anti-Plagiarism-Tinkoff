Module(body=[Import(names=[alias(name='numpy', asname='np')]), Import(names=[alias(name='torch')]), ImportFrom(module='unittest', names=[alias(name='TestCase'), alias(name='main')], level=0), ImportFrom(module='probabilistic_embeddings.layers.distribution', names=[alias(name='DiracDistribution'), alias(name='NormalDistribution')], level=0), ImportFrom(module='probabilistic_embeddings.layers.scorer', names=[alias(name='NegativeL2Scorer')], level=0), ImportFrom(module='probabilistic_embeddings.metrics.nearest', names=[alias(name='NearestNeighboursMetrics'), alias(name='MAPR')], level=0), ClassDef(name='TestUtils', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_knn', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[For(target=Name(id='backend', ctx=Store()), iter=List(elts=[Constant(value='faiss'), Constant(value='numpy'), Constant(value='torch')], ctx=Load()), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='DiracDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim'), Constant(value='spherical')], values=[Constant(value=2), Constant(value=False)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='metric', ctx=Store())], value=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='backend')], values=[Name(id='backend', ctx=Load())]))])), Assign(targets=[Name(id='x', ctx=Store())], value=Call(func=Attribute(value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=2), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=2.1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1.1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=0), Constant(value=1)], ctx=Load()), List(elts=[Constant(value=0), Constant(value=0)], ctx=Load())], ctx=Load())], keywords=[]), attr='float', ctx=Load()), args=[], keywords=[]), attr='reshape', ctx=Load()), args=[Tuple(elts=[UnaryOp(op=USub(), operand=Constant(value=1)), Constant(value=1), Constant(value=2)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='indices', ctx=Store())], value=Call(func=Attribute(value=Name(id='metric', ctx=Load()), attr='_multimodal_knn', ctx=Load()), args=[Name(id='x', ctx=Load()), Constant(value=2)], keywords=[])), Assign(targets=[Name(id='indices_gt', ctx=Store())], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='array', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=0), Constant(value=1)], ctx=Load()), List(elts=[Constant(value=1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=2), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=3), Constant(value=4)], ctx=Load()), List(elts=[Constant(value=4), Constant(value=3)], ctx=Load())], ctx=Load())], keywords=[]), attr='reshape', ctx=Load()), args=[Tuple(elts=[UnaryOp(op=USub(), operand=Constant(value=1)), Constant(value=1), Constant(value=2)], ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='allclose', ctx=Load()), args=[Name(id='indices', ctx=Load()), Name(id='indices_gt', ctx=Load())], keywords=[])], keywords=[]))], orelse=[])], decorator_list=[]), FunctionDef(name='test_gather', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='x', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=1), Constant(value=2)], ctx=Load()), List(elts=[Constant(value=3), Constant(value=4)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=6)], ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='index', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=0), Constant(value=2)], ctx=Load()), List(elts=[Constant(value=2), Constant(value=1)], ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Name(id='NearestNeighboursMetrics', ctx=Load()), attr='_gather_broadcast', ctx=Load()), args=[Subscript(value=Name(id='x', ctx=Load()), slice=Constant(value=None), ctx=Load()), Constant(value=1), Subscript(value=Name(id='index', ctx=Load()), slice=Tuple(elts=[Constant(value=Ellipsis), Constant(value=None)], ctx=Load()), ctx=Load())], keywords=[])), Assign(targets=[Name(id='result_gt', ctx=Store())], value=List(elts=[List(elts=[List(elts=[Constant(value=1), Constant(value=2)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=6)], ctx=Load())], ctx=Load()), List(elts=[List(elts=[Constant(value=5), Constant(value=6)], ctx=Load()), List(elts=[Constant(value=3), Constant(value=4)], ctx=Load())], ctx=Load())], ctx=Load())), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='allclose', ctx=Load()), args=[Name(id='result', ctx=Load()), Name(id='result_gt', ctx=Load())], keywords=[])], keywords=[]))], decorator_list=[]), FunctionDef(name='test_remove_duplicates', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='x', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=5), Constant(value=3), Constant(value=2), Constant(value=5), Constant(value=1), Constant(value=1), Constant(value=5)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=3), Constant(value=2), Constant(value=1), Constant(value=1), Constant(value=1)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=2), Constant(value=2), Constant(value=2), Constant(value=2), Constant(value=4)], ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Name(id='NearestNeighboursMetrics', ctx=Load()), attr='_remove_duplicates', ctx=Load()), args=[Name(id='x', ctx=Load()), Constant(value=3)], keywords=[])), Assign(targets=[Name(id='result_gt', ctx=Store())], value=List(elts=[List(elts=[Constant(value=5), Constant(value=3), Constant(value=2)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=3)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=2)], ctx=Load())], ctx=Load())), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='allclose', ctx=Load()), args=[Name(id='result', ctx=Load()), Name(id='result_gt', ctx=Load())], keywords=[])], keywords=[])), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Name(id='NearestNeighboursMetrics', ctx=Load()), attr='_remove_duplicates', ctx=Load()), args=[Name(id='x', ctx=Load()), Constant(value=6)], keywords=[])), Assign(targets=[Name(id='result_gt', ctx=Store())], value=List(elts=[List(elts=[Constant(value=5), Constant(value=3), Constant(value=2), Constant(value=1), Constant(value=1), Constant(value=5)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=3), Constant(value=2), Constant(value=1), Constant(value=1)], ctx=Load()), List(elts=[Constant(value=5), Constant(value=4), Constant(value=2), Constant(value=2), Constant(value=2), Constant(value=4)], ctx=Load())], ctx=Load())), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='allclose', ctx=Load()), args=[Name(id='result', ctx=Load()), Name(id='result_gt', ctx=Load())], keywords=[])], keywords=[]))], decorator_list=[]), FunctionDef(name='test_get_positives', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='DiracDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim'), Constant(value='spherical')], values=[Constant(value=1), Constant(value=False)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='metric', ctx=Store())], value=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=0), Constant(value=1), Constant(value=2), Constant(value=0)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=0)], ctx=Load()), List(elts=[Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1)], ctx=Load()), List(elts=[Constant(value=3)], ctx=Load()), List(elts=[Constant(value=5)], ctx=Load())], ctx=Load())], keywords=[]), attr='float', ctx=Load()), args=[], keywords=[])), Assign(targets=[Tuple(elts=[Name(id='scores', ctx=Store()), Name(id='counts', ctx=Store()), Name(id='same_mask', ctx=Store())], ctx=Store())], value=Call(func=Attribute(value=Name(id='metric', ctx=Load()), attr='_get_positives', ctx=Load()), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[])), Assign(targets=[Name(id='scores_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=0), UnaryOp(op=USub(), operand=Constant(value=1))], ctx=Load()), List(elts=[Constant(value=0), UnaryOp(op=USub(), operand=Constant(value=25))], ctx=Load()), List(elts=[Constant(value=0), UnaryOp(op=USub(), operand=Constant(value=1))], ctx=Load()), List(elts=[Constant(value=0), UnaryOp(op=USub(), operand=Constant(value=26))], ctx=Load()), List(elts=[Constant(value=0), UnaryOp(op=USub(), operand=Constant(value=25))], ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='counts_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=2), Constant(value=2), Constant(value=2), Constant(value=1), Constant(value=2)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='same_mask_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[List(elts=[Constant(value=1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1), Constant(value=0)], ctx=Load()), List(elts=[Constant(value=1), Constant(value=0)], ctx=Load())], ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Compare(left=Name(id='scores', ctx=Load()), ops=[Eq()], comparators=[Name(id='scores_gt', ctx=Load())]), attr='all', ctx=Load()), args=[], keywords=[])], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Compare(left=Name(id='counts', ctx=Load()), ops=[Eq()], comparators=[Name(id='counts_gt', ctx=Load())]), attr='all', ctx=Load()), args=[], keywords=[])], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Call(func=Attribute(value=Compare(left=Name(id='same_mask', ctx=Load()), ops=[Eq()], comparators=[Name(id='same_mask_gt', ctx=Load())]), attr='all', ctx=Load()), args=[], keywords=[])], keywords=[]))], decorator_list=[])], decorator_list=[]), ClassDef(name='TestMAPR', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_simple', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='DiracDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim'), Constant(value='spherical')], values=[Constant(value=1), Constant(value=False)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='metrics'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='mapr-ms')], ctx=Load()), Constant(value=1)]))])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=1), Constant(value=0), Constant(value=1), Constant(value=2), Constant(value=2), Constant(value=0), Constant(value=0), Constant(value=1)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=BinOp(left=Subscript(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='arange', ctx=Load()), args=[Call(func=Name(id='len', ctx=Load()), args=[Name(id='labels', ctx=Load())], keywords=[])], keywords=[]), slice=Tuple(elts=[Slice(), Constant(value=None)], ctx=Load()), ctx=Load()), op=Pow(), right=Constant(value=1.01))), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Subscript(value=Call(func=Name(id='m', ctx=Load()), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[]), slice=Constant(value='mapr-ms'), ctx=Load()), attr='item', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='result_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='mean', ctx=Load()), args=[List(elts=[BinOp(left=Constant(value=11), op=Div(), right=Constant(value=16)), BinOp(left=Constant(value=11), op=Div(), right=Constant(value=16)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=3)), BinOp(left=Constant(value=3), op=Div(), right=Constant(value=8)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=2)), Constant(value=1), BinOp(left=Constant(value=5), op=Div(), right=Constant(value=9)), BinOp(left=Constant(value=2), op=Div(), right=Constant(value=3)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=4))], ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Name(id='result', ctx=Load()), Name(id='result_gt', ctx=Load())], keywords=[])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='metrics'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='mapr')], ctx=Load()), Constant(value=1)]))])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=1), Constant(value=0), Constant(value=1), Constant(value=2), Constant(value=2), Constant(value=0), Constant(value=0), Constant(value=1)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=BinOp(left=Subscript(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='arange', ctx=Load()), args=[Call(func=Name(id='len', ctx=Load()), args=[Name(id='labels', ctx=Load())], keywords=[])], keywords=[]), slice=Tuple(elts=[Slice(), Constant(value=None)], ctx=Load()), ctx=Load()), op=Pow(), right=Constant(value=1.01))), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Subscript(value=Call(func=Name(id='m', ctx=Load()), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[]), slice=Constant(value='mapr'), ctx=Load()), attr='item', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='result_gt', ctx=Store())], value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='mean', ctx=Load()), args=[List(elts=[BinOp(left=Constant(value=5), op=Div(), right=Constant(value=9)), BinOp(left=Constant(value=5), op=Div(), right=Constant(value=9)), Constant(value=0), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=9)), Constant(value=0), Constant(value=1), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=4)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=2)), Constant(value=0)], ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Name(id='result', ctx=Load()), Name(id='result_gt', ctx=Load())], keywords=[]))], decorator_list=[]), FunctionDef(name='test_toy', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Expr(value=Constant(value='Eval MAP@R on toy examples from original paper.')), Assign(targets=[Name(id='sample_size', ctx=Store())], value=Constant(value=1000)), Assign(targets=[Name(id='mapr_gt', ctx=Store())], value=Dict(keys=[Tuple(elts=[Constant(value=0), Constant(value=1)], ctx=Load()), Tuple(elts=[Constant(value=0), Constant(value=None), Constant(value=1)], ctx=Load()), Tuple(elts=[Constant(value=0), Constant(value=None), Constant(value=0), Constant(value=1), Constant(value=None), Constant(value=1)], ctx=Load())], values=[Constant(value=0.779), Constant(value=0.998), Constant(value=0.714)])), Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='DiracDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim'), Constant(value='spherical')], values=[Constant(value=2), Constant(value=False)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='metrics'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='mapr-ms')], ctx=Load()), Constant(value=1)]))])), For(target=Tuple(elts=[Name(id='pattern', ctx=Store()), Name(id='gt', ctx=Store())], ctx=Store()), iter=Call(func=Attribute(value=Name(id='mapr_gt', ctx=Load()), attr='items', ctx=Load()), args=[], keywords=[]), body=[Assign(targets=[Name(id='embeddings1', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='rand', ctx=Load()), args=[Name(id='sample_size', ctx=Load()), Constant(value=2)], keywords=[])), Assign(targets=[Name(id='embeddings2', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='rand', ctx=Load()), args=[Name(id='sample_size', ctx=Load()), Constant(value=2)], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='_apply_pattern_inplace', ctx=Load()), args=[Name(id='embeddings1', ctx=Load()), Name(id='pattern', ctx=Load()), Constant(value=0)], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='_apply_pattern_inplace', ctx=Load()), args=[Name(id='embeddings2', ctx=Load()), Name(id='pattern', ctx=Load()), Constant(value=1)], keywords=[])), Assign(targets=[Name(id='embeddings', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='cat', ctx=Load()), args=[Tuple(elts=[Name(id='embeddings1', ctx=Load()), Name(id='embeddings2', ctx=Load())], ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='cat', ctx=Load()), args=[Tuple(elts=[Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='zeros', ctx=Load()), args=[Name(id='sample_size', ctx=Load())], keywords=[]), attr='long', ctx=Load()), args=[], keywords=[]), Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='ones', ctx=Load()), args=[Name(id='sample_size', ctx=Load())], keywords=[]), attr='long', ctx=Load()), args=[], keywords=[])], ctx=Load())], keywords=[])), Assign(targets=[Name(id='result', ctx=Store())], value=Call(func=Attribute(value=Subscript(value=Call(func=Name(id='m', ctx=Load()), args=[Name(id='embeddings', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[]), slice=Constant(value='mapr-ms'), ctx=Load()), attr='item', ctx=Load()), args=[], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertTrue', ctx=Load()), args=[Compare(left=Call(func=Name(id='abs', ctx=Load()), args=[BinOp(left=Name(id='result', ctx=Load()), op=Sub(), right=Name(id='gt', ctx=Load()))], keywords=[]), ops=[Lt()], comparators=[Constant(value=0.05)])], keywords=[]))], orelse=[])], decorator_list=[]), FunctionDef(name='_apply_pattern_inplace', args=arguments(posonlyargs=[], args=[arg(arg='self'), arg(arg='sample'), arg(arg='pattern'), arg(arg='label')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Expr(value=Constant(value='Apply pattern to uniform distribution.')), Assign(targets=[Name(id='pattern', ctx=Store())], value=Call(func=Name(id='tuple', ctx=Load()), args=[GeneratorExp(elt=Compare(left=Name(id='p', ctx=Load()), ops=[Eq()], comparators=[Name(id='label', ctx=Load())]), generators=[comprehension(target=Name(id='p', ctx=Store()), iter=Name(id='pattern', ctx=Load()), ifs=[], is_async=0)])], keywords=[])), Assign(targets=[Name(id='num_bins', ctx=Store())], value=Call(func=Name(id='sum', ctx=Load()), args=[Name(id='pattern', ctx=Load())], keywords=[])), AugAssign(target=Subscript(value=Name(id='sample', ctx=Load()), slice=Tuple(elts=[Slice(), Constant(value=0)], ctx=Load()), ctx=Store()), op=Mult(), value=Name(id='num_bins', ctx=Load())), For(target=Tuple(elts=[Name(id='i', ctx=Store()), Name(id='j', ctx=Store())], ctx=Store()), iter=Call(func=Name(id='reversed', ctx=Load()), args=[Call(func=Name(id='list', ctx=Load()), args=[Call(func=Name(id='enumerate', ctx=Load()), args=[Subscript(value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='nonzero', ctx=Load()), args=[Name(id='pattern', ctx=Load())], keywords=[]), slice=Constant(value=0), ctx=Load())], keywords=[])], keywords=[])], keywords=[]), body=[Assign(targets=[Name(id='mask', ctx=Store())], value=BinOp(left=Compare(left=Subscript(value=Name(id='sample', ctx=Load()), slice=Tuple(elts=[Slice(), Constant(value=0)], ctx=Load()), ctx=Load()), ops=[GtE()], comparators=[Name(id='i', ctx=Load())]), op=BitAnd(), right=Compare(left=Subscript(value=Name(id='sample', ctx=Load()), slice=Tuple(elts=[Slice(), Constant(value=0)], ctx=Load()), ctx=Load()), ops=[LtE()], comparators=[BinOp(left=Name(id='i', ctx=Load()), op=Add(), right=Constant(value=1))]))), AugAssign(target=Subscript(value=Name(id='sample', ctx=Load()), slice=Tuple(elts=[Name(id='mask', ctx=Load()), Constant(value=0)], ctx=Load()), ctx=Store()), op=Add(), value=BinOp(left=Name(id='j', ctx=Load()), op=Sub(), right=Name(id='i', ctx=Load())))], orelse=[]), AugAssign(target=Subscript(value=Name(id='sample', ctx=Load()), slice=Tuple(elts=[Slice(), Constant(value=0)], ctx=Load()), ctx=Store()), op=Mult(), value=BinOp(left=Constant(value=2), op=Div(), right=Call(func=Name(id='len', ctx=Load()), args=[Name(id='pattern', ctx=Load())], keywords=[])))], decorator_list=[])], decorator_list=[]), ClassDef(name='TestRecallK', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_simple', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='DiracDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim'), Constant(value='spherical')], values=[Constant(value=1), Constant(value=False)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=1), Constant(value=0), Constant(value=2), Constant(value=0), Constant(value=1)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=Subscript(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=0.5), Constant(value=1.5), Constant(value=3.5), Constant(value=4), Constant(value=5)], ctx=Load())], keywords=[]), slice=Tuple(elts=[Slice(), Constant(value=None)], ctx=Load()), ctx=Load())), Assign(targets=[Name(id='config', ctx=Store())], value=Dict(keys=[Constant(value='metrics'), Constant(value='recall_k_values'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='recall')], ctx=Load()), Tuple(elts=[Constant(value=1), Constant(value=2), Constant(value=3), Constant(value=4), Constant(value=5), Constant(value=10)], ctx=Load()), Constant(value=1)])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Name(id='config', ctx=Load()))]), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@1'), ctx=Load()), BinOp(left=Constant(value=2), op=Div(), right=Constant(value=5))], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@2'), ctx=Load()), BinOp(left=Constant(value=2), op=Div(), right=Constant(value=5))], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@3'), ctx=Load()), BinOp(left=Constant(value=3), op=Div(), right=Constant(value=5))], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@4'), ctx=Load()), Constant(value=1)], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@5'), ctx=Load()), Constant(value=1)], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='recall@10'), ctx=Load()), Constant(value=1)], keywords=[]))], decorator_list=[])], decorator_list=[]), ClassDef(name='TestERCRecallK', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_simple', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='NormalDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim')], values=[Constant(value=1)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=1), Constant(value=0), Constant(value=2), Constant(value=0), Constant(value=1)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='centers', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=0.5), Constant(value=1.5), Constant(value=3.5), Constant(value=4), Constant(value=5)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='confidences', ctx=Store())], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=2), Constant(value=4), Constant(value=5), Constant(value=3), Constant(value=1)], ctx=Load())], keywords=[]), attr='float', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='stack', ctx=Load()), args=[List(elts=[Name(id='centers', ctx=Load()), UnaryOp(op=USub(), operand=Name(id='confidences', ctx=Load()))], ctx=Load()), Constant(value=1)], keywords=[])), Assign(targets=[Name(id='config', ctx=Store())], value=Dict(keys=[Constant(value='metrics'), Constant(value='recall_k_values'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='erc-recall@1')], ctx=Load()), Tuple(elts=[Constant(value=1), Constant(value=2), Constant(value=3), Constant(value=4), Constant(value=5), Constant(value=10)], ctx=Load()), Constant(value=1)])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Name(id='config', ctx=Load()))]), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[])), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='erc-recall@1'), ctx=Load()), BinOp(left=Constant(value=1), op=Sub(), right=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='mean', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=0), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=3)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=4)), BinOp(left=Constant(value=2), op=Div(), right=Constant(value=5))], ctx=Load())], keywords=[]))], keywords=[keyword(arg='places', value=Constant(value=6))]))], decorator_list=[])], decorator_list=[]), ClassDef(name='TestERCMAPR', bases=[Name(id='TestCase', ctx=Load())], keywords=[], body=[FunctionDef(name='test_simple', args=arguments(posonlyargs=[], args=[arg(arg='self')], kwonlyargs=[], kw_defaults=[], defaults=[]), body=[Assign(targets=[Name(id='d', ctx=Store())], value=Call(func=Name(id='NormalDistribution', ctx=Load()), args=[], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='dim')], values=[Constant(value=1)]))])), Assign(targets=[Name(id='s', ctx=Store())], value=Call(func=Name(id='NegativeL2Scorer', ctx=Load()), args=[Name(id='d', ctx=Load())], keywords=[])), Assign(targets=[Name(id='labels', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=1), Constant(value=1), Constant(value=0), Constant(value=1), Constant(value=2), Constant(value=2), Constant(value=0), Constant(value=0), Constant(value=1)], ctx=Load())], keywords=[])), Assign(targets=[Name(id='centers', ctx=Store())], value=BinOp(left=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='arange', ctx=Load()), args=[Call(func=Name(id='len', ctx=Load()), args=[Name(id='labels', ctx=Load())], keywords=[])], keywords=[]), op=Pow(), right=Constant(value=1.01))), Assign(targets=[Name(id='confidences', ctx=Store())], value=Call(func=Attribute(value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='tensor', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=2), Constant(value=4), Constant(value=6), Constant(value=8), Constant(value=7), Constant(value=5), Constant(value=3), Constant(value=1)], ctx=Load())], keywords=[]), attr='float', ctx=Load()), args=[], keywords=[])), Assign(targets=[Name(id='parameters', ctx=Store())], value=Call(func=Attribute(value=Name(id='torch', ctx=Load()), attr='stack', ctx=Load()), args=[List(elts=[Name(id='centers', ctx=Load()), UnaryOp(op=USub(), operand=Name(id='confidences', ctx=Load()))], ctx=Load()), Constant(value=1)], keywords=[])), Assign(targets=[Name(id='m', ctx=Store())], value=Call(func=Call(func=Name(id='NearestNeighboursMetrics', ctx=Load()), args=[Name(id='d', ctx=Load()), Name(id='s', ctx=Load())], keywords=[keyword(arg='config', value=Dict(keys=[Constant(value='metrics'), Constant(value='prefetch_factor')], values=[List(elts=[Constant(value='erc-mapr')], ctx=Load()), Constant(value=1)]))]), args=[Name(id='parameters', ctx=Load()), Name(id='labels', ctx=Load())], keywords=[])), Assign(targets=[Name(id='maprs', ctx=Store())], value=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='array', ctx=Load()), args=[List(elts=[Constant(value=0), Constant(value=1), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=9)), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=4)), Constant(value=0), BinOp(left=Constant(value=1), op=Div(), right=Constant(value=2)), BinOp(left=Constant(value=5), op=Div(), right=Constant(value=9)), Constant(value=0), BinOp(left=Constant(value=5), op=Div(), right=Constant(value=9))], ctx=Load())], keywords=[])), Assign(targets=[Name(id='erc_mapr_gt', ctx=Store())], value=BinOp(left=Constant(value=1), op=Sub(), right=Call(func=Attribute(value=BinOp(left=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='cumsum', ctx=Load()), args=[Name(id='maprs', ctx=Load())], keywords=[]), op=Div(), right=Call(func=Attribute(value=Name(id='np', ctx=Load()), attr='arange', ctx=Load()), args=[Constant(value=1), BinOp(left=Call(func=Name(id='len', ctx=Load()), args=[Name(id='maprs', ctx=Load())], keywords=[]), op=Add(), right=Constant(value=1))], keywords=[])), attr='mean', ctx=Load()), args=[], keywords=[]))), Expr(value=Call(func=Attribute(value=Name(id='self', ctx=Load()), attr='assertAlmostEqual', ctx=Load()), args=[Subscript(value=Name(id='m', ctx=Load()), slice=Constant(value='erc-mapr'), ctx=Load()), Name(id='erc_mapr_gt', ctx=Load())], keywords=[keyword(arg='places', value=Constant(value=6))]))], decorator_list=[])], decorator_list=[]), If(test=Compare(left=Name(id='__name__', ctx=Load()), ops=[Eq()], comparators=[Constant(value='__main__')]), body=[Expr(value=Call(func=Name(id='main', ctx=Load()), args=[], keywords=[]))], orelse=[])], type_ignores=[])